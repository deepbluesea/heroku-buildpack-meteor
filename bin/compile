#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2
METEOR_HOME=$BUILD_DIR/.meteor/build
PATH=$METEOR_HOME:$PATH
mkdir -p ~/.nodes && cd ~/.nodes
curl -O http://nodejs.org/dist/v0.10.13/node-v0.10.13-linux-x64.tar.gz
tar -xzf node-v0.10.13-linux-x64.tar.gz
rm node-v0.10.13-linux-x64.tar.gz
mv node-v0.10.13-linux-x64 0.10.13
ln -s 0.10.13 current
export PATH="~/.nodes/current/bin:$PATH"
install_meteor() {
  cd $BUILD_DIR
  echo "Installing meteor"
  git clone git://github.com/meteor/meteor.git $METEOR_HOME
}

build() {
  (
    echo "Building meteor bundle"
    meteor bundle $CACHE_DIR/bundle.tar.gz
    mkdir -p $BUILD_DIR/.meteor/local/build
    tar -zxf $CACHE_DIR/bundle.tar.gz --strip-components 1 -C $BUILD_DIR/.meteor/local/build
    rm $CACHE_DIR/bundle.tar.gz
  )
}

[ ! -d $BUILD_DIR ] && mkdir $BUILD_DIR
[ ! -d $CACHE_DIR ] && mkdir $CACHE_DIR

install_meteor
build

echo "Checking for post_compile script"
if [ -f $BUILD_DIR/bin/post_compile ] ; then
    echo "-----> Running post_compile hook"
    chmod +x $BUILD_DIR/bin/post_compile
    $BUILD_DIR/bin/post_compile
fi
